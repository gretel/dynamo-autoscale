#!/usr/bin/env ruby

require 'rubygems'
require 'commander'

require_relative '../lib/dynamo-autoscale/version'
require_relative '../lib/dynamo-autoscale/cli'

class Command
  include Commander::Methods

  def run
    program :name, 'dynamo-autoscale'
    program :version, DynamoAutoscale::VERSION
    program :description, 'CLI to manage dynamo-autoscale in a nice way.'
    # default_command :help
    global_option('--debug', 'Enable debbuging output for development purposes.') { $_DEBUG_LOG = true }
    global_option('--pretty', 'Enable colorful and possibly pretty output.')

    command :start do |c|
      c.syntax = "dynamo-autoscale-cmd #{c.name}"
      c.description = 'Monitor process running.'
      c.option '--config PATH', String, 'Configuration file.'
      c.option '--dry_run', nil, 'Do not actually touch the API endpoint.'
      c.option '--monitor', nil, 'Enable interactive monitoring.'
      c.action do |args, options|
        unless options.config
          say 'option --config PATH is required.'
          exit 1
        end
        DynamoAutoscale::CLI.run(c.name, options)
      end
    end

    command 'check_ruleset' do |c|
      c.syntax = "dynamo-autoscale-cmd #{c.name}"
      c.description = 'Validate the scaling ruleset defined.'
      c.option '--config PATH', String, 'Configuration file.'
      c.action do |args, options|
        unless options.config
          say 'option --config PATH is required.'
          exit 1
        end
        DynamoAutoscale::CLI.run(c.name, options)
      end
    end

    command 'check_email' do |c|
      c.syntax = "dynamo-autoscale-cmd #{c.name}"
      c.description = 'Try to send notification email.'
      c.option '--config PATH', String, 'Configuration file.'
      c.action do |args, options|
        unless options.config
          say 'option --config PATH is required.'
          exit 1
        end
        DynamoAutoscale::CLI.run(c.name, options)
      end
    end

    command 'test_random' do |c|
      c.syntax = "dynamo-autoscale-cmd #{c.name}"
      c.description = 'Run a dry and random test.'
      c.option '--graph', nil, 'Output a graph.'
      c.option '--config PATH', String, 'Configuration file.'
      c.action do |args, options|
        unless options.config
          say 'option --config PATH is required.'
          exit 1
        end
        DynamoAutoscale::CLI.run(c.name, options)
      end
    end

    command 'test_simulate' do |c|
      c.syntax = "dynamo-autoscale-cmd #{c.name}"
      c.description = 'Run a simulation test.'
      c.option '--config PATH', String, 'Configuration file.'
      c.action do |args, options|
        unless options.config
          say 'option --config PATH is required.'
          exit 1
        end
        DynamoAutoscale::CLI.run(c.name, options)
      end
    end

    command 'pull_cw_data' do |c|
      c.syntax = "dynamo-autoscale-cmd #{c.name}"
      c.description = 'Get historic data from the CloudWatch API.'
      c.option '--config PATH', String, 'Configuration file.'
      c.action do |args, options|
        unless options.config
          say 'option --config PATH is required.'
          exit 1
        end
        DynamoAutoscale::CLI.run(c.name, options)
      end
    end

    command 'lament_wastage' do |c|
      c.syntax = "dynamo-autoscale-cmd #{c.name}"
      c.description = 'Calculate what a waste of money this is.'
      c.option '--config PATH', String, 'Configuration file.'
      c.action do |args, options|
        unless options.config
          say 'option --config PATH is required.'
          exit 1
        end
        DynamoAutoscale::CLI.run(c.name, options)
      end
    end

    command 'dump_stats' do |c|
      c.syntax = "dynamo-autoscale-cmd #{c.name}"
      c.description = 'Send signal to process to let it dump some statistics.'
      c.option '--config PATH', String, 'Configuration file.'
      c.action do |args, options|
        unless options.config
          say 'option --config PATH is required.'
          exit 1
        end
        DynamoAutoscale::CLI.run(c.name, options)
      end
    end
    begin
      run!
    rescue => e
      if $_DEBUG_LOG
        STDERR.puts sprintf("%s\n%s", e, e.backtrace.join("\n"))
      else
        STDERR.puts "Exception, doh! (#{e.class}: #{e.message})"
      end
      exit -2
    end
  end
end

Command.new.run #if $0 == __FILE__
